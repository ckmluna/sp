<?php  session_start();  $allowedExts = array("txt");  $temp = explode(".", $_FILES["file"]["name"]);  $extension = end($temp);  if ($_FILES["file"]["type"] == "text/plain" && in_array($extension, $allowedExts))  {    if ($_FILES["file"]["error"] > 0)    {      echo "Return Code: " . $_FILES["file"]["error"] . "<br>";    }    else    {      move_uploaded_file($_FILES["file"]["tmp_name"],"upload/co.txt");      if (($handle = fopen("upload/co.txt", "r")) !== FALSE)      {        $data = fgetcsv($handle, 1000, ",");        $conn = pg_connect("host=localhost port=5432 dbname=postgres user=postgres password=password")or die("Could not connect to server!\n");        $query = "INSERT INTO course_offering (dept_id, semester, academic_year) VALUES ('".$data[0]."','".$data[1]."','".$data[2]."')";        $result = pg_query($conn,$query);        $sql = pg_query($conn, "SELECT LASTVAL()")or die("Query failed with error: ".pg_last_error($conn));        $last_co_id = pg_fetch_row($sql);        while (($data = fgetcsv($handle, 1000, ",")) !== FALSE)        {          $query = "INSERT INTO lec_section (section_name, course_id, time, faculty_id, day, room, co_id) VALUES ('".$data[0]."','".$data[1]."','".$data[2]."','".$data[3]."','".$data[4]."','".$data[5]."','".$last_co_id[0]."')";          $result = pg_query($conn,$query);          $sql = pg_query($conn, "SELECT LASTVAL()")or die("Query failed with error: ".pg_last_error($conn));          $last_lec_id = pg_fetch_row($sql);          $labs = $data[6];          $total_size = 0;          for ($i=0; $i<$labs; $i++)          {            $data = fgetcsv($handle, 1000, ",");            $query = "INSERT INTO lab_section (section_no, time, day, room, class_size, faculty_id, lecture_id) VALUES ('".$data[0]."','".$data[1]."','".$data[2]."','".$data[3]."','".$data[4]."','".$data[5]."','".$last_lec_id[0]."')";            $result = pg_query($conn,$query);            $total_size += $data[4];          }          $query = pg_query($conn, "UPDATE lec_section SET class_size='".$total_size."' WHERE id_no = '".$last_lec_id[0]."'")or die("Query failed with error: ".pg_last_error($conn));          $result = pg_query($conn,$query);        }        fclose($handle);        header('Location: uploadcourseoffering.php?uploaded');      }    }  }  else  {    header('Location: uploadcourseoffering.php?invalid');  }?>